<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spiel Daten Visualisierung</title>
    <script src="https://cdn.jsdelivr.net/npm/context-filter-polyfill/dist/index.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Ruda:wght@900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="header">
        <h1>Spielbericht Auswahl</h1>
        <p>Wählen Sie ein Datum aus und laden Sie die verfügbaren Spiele</p>
    </div>
    <div style="text-align: center; margin: 20px 0;">
        <label for="datumAuswahlBericht">Datum auswählen:</label>
        <input type="date" id="datumAuswahlBericht">
    </div>
    <div style="text-align: center; margin: 20px 0;">
        <label for="hintergrundAuswahlBericht">Hintergrundbild auswählen:</label>
        <br>
        <div style="display: flex; justify-content: center; gap: 20px; margin-top: 10px;">
            <label>
                <input type="radio" name="hintergrundOption" value="damen.jpg">
                <img id="hintergrundDamenImg"src="damen.jpg" alt="Damen Hintergrund" style="width: 150px; height: auto; border: 1px solid #000;">
            </label>
            <label>
                <input type="radio" name="hintergrundOption" value="herren.jpg">
                <img id="hintergrundHerrenImg" src="herren.jpg" alt="Herren Hintergrund" style="width: 150px; height: auto; border: 1px solid #000;">
            </label>
            <label>
                <input type="radio" name="hintergrundOption" value="hochladen">Eigenes Bild hochladen
            </label>
            <input type="file" id="hintergrundHochladen" accept="image/*" style="display: none; margin-top: 10px;">
        </div>
    </div>
    <div style="text-align: center; margin: 20px 0;">
        <button id="spieleLaden">Spiele laden</button>
    </div>
    <div style="text-align: center; margin: 20px 0;">
        <div id="spieleContainer">
            <h2 style="text-align: center;">Verfügbare Spiele</h2>
            <table id="spieleTabelle" class="schedule-table">
                <thead>
                    <tr>
                        <th>Auswahl</th>
                        <th>Liga</th>
                        <th>Team A</th>
                        <th>Team B</th>
                        <th>Resultat</th>
                        <th class="hidden-column">Ort</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
        <div style="text-align: center; margin: 20px 0;">
            <button id="bildGenerieren">Bild generieren</button>
        </div>
        <img id="spielBildBericht" alt="Spiel Bild" style="display: none; margin: 0 auto;" />
        <a id="downloadLink" style="display: none; text-align: center; margin: 20px 0;">Bild herunterladen</a>
    </div>
    <script>
        const API_URL = "https://atvkv.ch/wp-json/handballplugin/v1/shv-api?teamid=alle&typ=Spiele";
        let uploadedImageUrl = null;
        const fallbackImageUrl = "fallback-image.jpg"; // Pfad zu einem tatsächlichen Fallback-Bild

        $(document).ready(function () {
            // Spiele laden
            $('#spieleLaden').on('click', function () {
                loadGames(3);
            });

            // Hintergrundbild hochladen
            $('#hintergrundHochladen').on('change', function (event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function (e) {
                        uploadedImageUrl = e.target.result;
                    };
                    reader.onerror = function () {
                        alert("Fehler beim Hochladen des Bildes. Bitte versuchen Sie es erneut.");
                    };
                    reader.readAsDataURL(file);
                }
            });

            // Anzeige von Bild hochladen, wenn "Eigenes Bild hochladen" ausgewählt wird
            $('input[name="hintergrundOption"]').on('change', function () {
                const selectedOption = $('input[name="hintergrundOption"]:checked').val();
                if (selectedOption === 'hochladen') {
                    $('#hintergrundHochladen').show();
                } else {
                    $('#hintergrundHochladen').hide();
                    uploadedImageUrl = selectedOption;
                }
            });

            // Bild generieren
            $('#bildGenerieren').on('click', function () {
                const modus = 'normal';
                const selectedGames = $('.spielAuswahl:checked').closest('tr');
                if (selectedGames.length > 0) {
                    generateImage(selectedGames, modus);
                } else {
                    alert("Bitte mindestens ein Spiel auswählen.");
                }
            });

            // Spiele laden Funktion mit Fehlerbehandlung
            function loadGames(attempt) {
                const selectedDate = $('#datumAuswahlBericht').val();
                if (!selectedDate) {
                    alert("Bitte ein Datum auswählen.");
                    return;
                }

                if (attempt <= 0) {
                    alert("Fehler beim Abrufen der Spieldaten. Bitte versuchen Sie es später erneut.");
                    return;
                }

                $.getJSON(API_URL)
                    .done(function (data) {
                        const filteredData = data.filter(function (spiel) {
                            return spiel.gameDateTime && spiel.gameDateTime.startsWith(selectedDate);
                        });

                        if (filteredData.length === 0) {
                            $('#spieleTabelle tbody').empty();
                            alert("Keine Spiele für das ausgewählte Datum gefunden.");
                            return;
                        }

                        filteredData.sort(function (a, b) {
                            return new Date(a.gameDateTime) - new Date(b.gameDateTime);
                        });

                        $('#spieleTabelle tbody').empty();
                        filteredData.forEach(function (spiel, index) {
                            const spielRow = `
                                <tr>
                                    <td><input type="checkbox" class="spielAuswahl" value="${index}"></td>
                                    <td contenteditable="true">${spiel.leagueShort}</td>
                                    <td contenteditable="true">${spiel.teamAName}</td>
                                    <td contenteditable="true">${spiel.teamBName}</td>
                                    <td contenteditable="true">${spiel.teamAScoreFT}:${spiel.teamBScoreFT} (${spiel.teamAScoreHT}:${spiel.teamBScoreHT})</td>
                                    <td contenteditable="true" class="hidden-column">${spiel.venue}</td>
                                </tr>`;
                            $('#spieleTabelle tbody').append(spielRow);
                        });
                    })
                    .fail(function () {
                        console.error("Fehler beim Abrufen der Spieldaten. Neuer Versuch...");
                        loadGames(attempt - 1);
                    });
            }

            function generateImage(selectedGames, modus) {
    const canvas = document.createElement('canvas');
    canvas.width = 1080;
    canvas.height = 1080;
    const ctx = canvas.getContext('2d');

    const img = new Image();
    img.crossOrigin = "anonymous";  // Cross-Origin-Attribut setzen
    img.src = uploadedImageUrl ? uploadedImageUrl : fallbackImageUrl;

    img.onload = function () {
        try {
            // Hintergrundbild zeichnen
            ctx.filter = 'grayscale(100%) blur(2px)';
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            ctx.filter = 'none';

            // Gelber Bereich oben
            ctx.fillStyle = '#FFCC00';
            ctx.fillRect(0, 0, canvas.width, 250);

            // Blauer Bereich unten
            ctx.fillStyle = 'rgba(44, 74, 154, 1)';
            ctx.fillRect(0, canvas.height - 250, canvas.width, 250);

             const selectedDate = $('#datumAuswahl').val();
                const datumText = new Date(selectedDate).toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                const ort = $(selectedGames[0]).find('td:nth-child(6)').text();
                ctx.font = '40px Ruda';
                ctx.fillText(datumText, canvas.width / 2, 150);
                ctx.fillText(`@${ort}`, canvas.width / 2, 200);

                // Spielinformationen
                const league = $(selectedGames[0]).find('td:nth-child(2)').text();
                const teamA = $(selectedGames[0]).find('td:nth-child(3)').text();
                const teamB = $(selectedGames[0]).find('td:nth-child(4)').text();
                const result = $(selectedGames[0]).find('td:nth-child(5)').text();

                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                const contentHeight = 5 * 80; // Height of all text blocks combined (5 elements, each with 80px height)
                let yPosition = 250 + (580 - contentHeight) / 2;

                ctx.fillStyle = 'rgba(44, 74, 154, 0.85)';
                const padding = 40;
                ctx.fillRect(padding, yPosition - 40, canvas.width - 2 * padding, contentHeight + 80);

                ctx.fillStyle = 'white';
                ctx.fillText(league, canvas.width / 2, yPosition + 30);

                yPosition += 80;
                ctx.fillText(teamA, canvas.width / 2, yPosition + 30);

                yPosition += 80;
                ctx.fillText('vs.', canvas.width / 2, yPosition + 12);

                yPosition += 80;
                ctx.fillText(teamB, canvas.width / 2, yPosition);

                yPosition += 80;
		ctx.font = 'bold 80px Ruda';
                ctx.fillText(result, canvas.width / 2, yPosition + 30);
            // Logo
	   const logos =  ["ATvKvOhneText150.png"]
	   preloadLogos(logos, function(images) {
                    let totalLogoWidth = images.length * 301 + (images.length - 1) * 50;
                    let xPosition = (canvas.width - totalLogoWidth) / 2;
                    images.forEach(function(logoImg) {
                        if (logoImg) {
                            ctx.drawImage(logoImg, xPosition, canvas.height - 200);
                            xPosition += 250;
                        } else {
                            ctx.fillStyle = 'white';
                            ctx.font = 'bold 20px Ruda';
                            ctx.textAlign = 'center';
                            ctx.fillText('Logo nicht geladen', xPosition + 100, canvas.height - 80);
                            xPosition += 301;
                        }
                    });


            // Generiertes Bild als Data-URL anzeigen
            const imageUrl = canvas.toDataURL('image/jpeg');
            $('#spielBildBericht').attr('src', imageUrl).show();

            const downloadLink = $('#downloadLink');
            downloadLink.attr('href', imageUrl);
            downloadLink.attr('download', 'spielbericht.jpg');
            downloadLink.text('Bild herunterladen');
            downloadLink.show();
        } catch (error) {
            console.error("Fehler beim Exportieren des Canvas: ", error);
            alert("Es gab ein Problem beim Generieren des Bildes. Versuchen Sie es mit einem anderen Hintergrundbild.");
        }
    };

    img.onerror = function () {
        alert("Fehler beim Laden des Hintergrundbildes. Bitte überprüfen Sie den Bildpfad.");
    };
}
        });
    </script>
</body>
</html>
